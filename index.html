<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>محرك النوايا الحكومية - GIE</title>
<style>
:root{
  --green-1:#007a4a;
  --green-2:#9fe6cf;
  --muted:#6b6b6b;
  --card:#ffffff;
  --bg:#f3f6f5;
  --accent:#f0fff8;
}
*{box-sizing:border-box}
body{
  font-family: "Segoe UI", Tahoma, Arial, "Noto Kufi Arabic", sans-serif;
  margin:0; padding:24px; background:var(--bg); color:#0b2b22;
  -webkit-font-smoothing:antialiased; display:flex; justify-content:center; align-items:center;
}
.app{max-width:980px; width:100%;}
.card{
  background:var(--card); border-radius:14px; padding:18px;
  box-shadow:0 6px 18px rgba(12,34,24,0.06); margin-bottom:24px;
}
.input-area textarea{
  width:100%; min-height:84px; resize:vertical; padding:12px;
  border-radius:10px; border:1px solid #e6efe9; font-size:15px; direction:rtl; font-family:inherit;
}
.controls{display:flex; gap:10px; margin-top:10px}
.btn{
  background:var(--green-1); border:none; color:white; padding:10px 14px; border-radius:10px;
  cursor:pointer; font-weight:600; transition:transform .12s ease,box-shadow .12s;
}
.btn:active{transform:translateY(1px)}
.btn.secondary{background:#2b7e63}
.result-box{margin-top:16px; display:none}
.intent{
  display:flex; align-items:center; gap:12px; padding:12px; border-radius:10px;
  background:var(--accent); border:1px solid #e3f3ec;
}
.intent .icon{
  width:54px;height:54px;border-radius:10px;background:linear-gradient(180deg,var(--green-2),#e6faf0);
  display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--green-1)
}
.intent .meta{flex:1}
.intent .meta h3{margin:0;font-size:16px;color:var(--green-1)}
.intent .meta p{margin:4px 0 0;color:var(--muted);font-size:13px}
.services{margin-top:12px;display:grid;gap:8px}
.service-card{background:#fff;padding:12px;border-radius:10px;border:1px solid #eef7f1}
.service-card h4{margin:0 0 8px;font-size:14px;color:#0b2b22}
.service-card ul{margin:0;padding-right:18px}
.service-card li{margin:6px 0;color:#333;font-size:14px}
.checks{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
.check{padding:8px 10px;border-radius:8px;background:#fff;border:1px solid #f0f7f2;color:#4a4a4a;font-size:13px}
.execute-row{display:flex;gap:12px;margin-top:14px;align-items:center}
.status{font-size:14px;color:var(--muted)}
</style>
</head>
<body>

<div class="app">

<section class="card">
  <div class="input-area">
    <label style="font-weight:700;margin-bottom:6px;display:block">اكتب طلبك (نص حر)</label>
    <textarea id="userText" placeholder="مثال: أبغى أسافر مع زوجي وطفلين بكرة"></textarea>
    <div class="controls">
      <button class="btn" onclick="analyze()">تحليل النية</button>
      <button class="btn secondary" onclick="clearAll()">مسح</button>
    </div>
  </div>

  <div id="resultBox" class="result-box">
    <div class="intent">
      <div class="icon" id="intentIcon">NI</div>
      <div class="meta">
        <h3 id="intentTitle">نية: ...</h3>
        <p id="intentDesc">تحليل سياق المستخدم وتوليد حزمة خدمات.</p>
      </div>
      <div style="min-width:120px;text-align:left">
        <div style="font-size:12px;color:var(--muted)">تاريخ الاكتشاف</div>
        <div id="detectedAt" style="font-weight:700"></div>
      </div>
    </div>

    <div class="services" id="servicesContainer"></div>
    <div class="checks" id="checksContainer"></div>
    <div class="execute-row">
      <button class="btn" id="executeBtn" onclick="executePackage()">تنفيذ كلّ المتطلبات</button>
      <div class="status" id="execStatus">الاستعداد: <strong id="readyText">غير جاهز</strong></div>
    </div>
  </div>
</section>

</div>

<script>
// دالة تطبيع الكلمات: حذف همزات وألف مقصورة، وتحويل كل النص لصغير
function normalizeArabic(text){
  return text.replace(/[اأإآ]/g,"ا")
             .replace(/[ى]/g,"ي")
             .replace(/[ؤ]/g,"و")
             .replace(/[ئ]/g,"ي")
             .replace(/ة/g,"ه")
             .replace(/[^ء-ي0-9a-zA-Z\s]/g,"")
             .toLowerCase();
}

// قاعدة بيانات النوايا والخدمات
const INTENT_DEFINITIONS = [
  {id:"travel",title:"خدمات السفر",
   keywords:["سافر","سفر","تذكرة","مطار","رحلة","مغادرة"],
   services:[
     "التحقق من صلاحية الجواز",
     "التحقق من المخالفات المرورية",
     "التحقق من التطعيمات المطلوبة",
     "إصدار تأمين السفر",
     "إصدار تصاريح السفر للمرافقين",
     "تصريح خروج المركبة (إن وُجد)"
   ], checks:["passport_validity","traffic_fines","vaccination","travel_permission"]
  },
  {id:"newborn",title:"خدمات المواليد",
   keywords:["مولود","ولدت","طفل","ولادة","بيبي"],
   services:[
     "إصدار شهادة الميلاد",
     "إضافة مولود في السجل الوطني",
     "التسجيل في التطعيمات",
     "إضافة تابع في التأمين الصحي"
   ], checks:["hospital_report","family_record"]
  },
  {id:"fraud_report",title:"خدمات البلاغات",
   keywords:["بلاغ","احتيال","نصب","سرق","انسرق"],
   services:[
     "فتح بلاغ احتيال مالي",
     "فتح بلاغ إلكتروني/جرائم الإنترنت",
     "تجميد الحساب إذا لزم",
     "تقديم تذكرة للبنك/المؤسسة"
   ], checks:["fraud_flag","related_accounts"]
  },
  {id:"vehicle",title:"خدمات المركبات",
   keywords:["سيارة","مركبة","استمارة","فحص","رخصة","رقم","لوحة"],
   services:[
     "تجديد الاستمارة",
     "حجز فحص دوري",
     "سداد المخالفات",
     "تجديد رخصة القيادة"
   ], checks:["vehicle_reg","traffic_fines"]
  },
  {id:"residency",title:"خدمات الهوية والإقامة",
   keywords:["اقامه","اقامة","هوية","بطاقة","تجديد اقامه","تجديد هوية"],
   services:[
     "تجديد الإقامة/الهوية",
     "التحقق من رسوم التجديد",
     "طباعة المستندات الرسمية"
   ], checks:["id_status","fees"]
  },
  {id:"health",title:"خدمات الصحة",
   keywords:["تطعيم","لقاح","عيادة","مستشفى","فحص","تحاليل"],
   services:[
     "حجز موعد في مركز صحي",
     "التحقق من حالة التطعيم",
     "تحديث السجل الطبي"
   ], checks:["vaccination","medical_records"]
  }
];

// محاكاة الفحوصات
function simulateCheck(checkId, userContext){
  const rand = Math.random();
  if (checkId.includes("passport") || checkId.includes("id")){
    if ((userContext.text||"").includes("قرب") || (userContext.text||"قريب")) return {status:"FAIL",detail:"مطلوب تجديد خلال 3 أشهر"};
    return {status: rand>0.25?"OK":"FAIL",detail: rand>0.25?"ساري":"قريب الانتهاء"};
  }
  if (checkId.includes("fine") || checkId.includes("traffic")){
    return {status: rand>0.5?"OK":"FAIL",detail: rand>0.5?"لا مخالفات":"يوجد مخالفات مسددة"};
  }
  if (checkId.includes("vaccination") || checkId.includes("vacc")){
    return {status: rand>0.5?"OK":"FAIL",detail: rand>0.5?"التطعيمات مكتملة":"تحتاج جرعة"};
  }
  return {status: rand>0.6?"OK":"FAIL",detail: rand>0.6?"تم":"مطلوب إجراء إضافي"};
}

// التعرف على النية
function detectIntent(text){
  let orig = text;
  text = normalizeArabic(text);

  let best={score:0,intent:null};
  INTENT_DEFINITIONS.forEach(def=>{
    def.keywords.forEach(k=>{
      let normKey = normalizeArabic(k);
      // البحث الجزئي مع تجاهل بادئات "ب" أو "و"
      const regex = new RegExp("(?:^|\\s)[بو]?"+normKey,"i");
      if (regex.test(text)) best.score += 3;
    });
    if (best.score>best.score) best={score:best.score,intent:def};
  });

  // اختيار أول نية تطابق
  let matched = INTENT_DEFINITIONS.find(def=>{
    return def.keywords.some(k=>{
      let normKey = normalizeArabic(k);
      const regex = new RegExp("(?:^|\\s)[بو]?"+normKey,"i");
      return regex.test(text);
    });
  });

  if (!matched) return {id:"unknown",title:"لم يتم التعرف على النية",services:[],checks:[],meta:{text:orig}};
  return {id:matched.id,title:matched.title,services:matched.services,checks:matched.checks,meta:{text:orig}};
}

// عرض الحزمة
function showPackage(pkg){
  const box = document.getElementById("resultBox");
  const titleEl = document.getElementById("intentTitle");
  const iconEl = document.getElementById("intentIcon");
  const descEl = document.getElementById("intentDesc");
  const servicesContainer = document.getElementById("servicesContainer");
  const checksContainer = document.getElementById("checksContainer");
  const detectedAt = document.getElementById("detectedAt");
  const readyText = document.getElementById("readyText");
  document.getElementById("execStatus").style.display="block";

  if (!pkg || pkg.id==="unknown"){
    box.style.display="block";
    titleEl.innerText="لم يتم التعرف على النية";
    iconEl.innerText="؟";
    descEl.innerText="حاولي إعادة صياغة طلبك";
    servicesContainer.innerHTML="";
    checksContainer.innerHTML="";
    readyText.innerText="غير جاهز";
    return;
  }

  titleEl.innerText=pkg.title;
  iconEl.innerText=pkg.id.slice(0,2).toUpperCase();
  descEl.innerText="حزمة خدمات مقترحة بناء على النية المكتشفة";
  detectedAt.innerText=new Date().toLocaleString();

  servicesContainer.innerHTML="";
  const sCard=document.createElement("div");
  sCard.className="service-card";
  sCard.innerHTML=`<h4>خدمات مقترحة</h4>`;
  const ul=document.createElement("ul");
  (pkg.services||[]).forEach(s=>{
    const li=document.createElement("li"); li.innerText=s; ul.appendChild(li);
  });
  sCard.appendChild(ul);
  servicesContainer.appendChild(sCard);

  checksContainer.innerHTML="";
  (pkg.checks||[]).forEach(ch=>{
    const res=simulateCheck(ch,pkg.meta||{text:""});
    const chip=document.createElement("div"); chip.className="check";
    chip.innerText=`${mapCheckLabel(ch)} — ${res.status} (${res.detail})`;
    checksContainer.appendChild(chip);
  });

  const allOk=Array.from(checksContainer.children).every(c=>c.innerText.includes("OK")||c.innerText.includes("تم")||c.innerText.includes("ساري")||c.innerText.includes("مكتملة"));
  readyText.innerText=allOk?"جاهز للتنفيذ":"نحتاج خطوات تصحيحية";
  box.style.display="block";
}

function mapCheckLabel(id){
  const map={
    passport_validity:"انتهاء الجواز؟",
    traffic_fines:"مخالفات مرورية؟",
    vaccination:"حالة التطعيم",
    travel_permission:"قيود/تصاريح سفر",
    hospital_report:"تقرير مستشفى",
    family_record:"السجل العائلي",
    fraud_flag:"سجل احتيال إن وجد",
    related_accounts:"حسابات مرتبطة",
    vehicle_reg:"تسجيل المركبة",
    id_status:"حالة الهوية",
    fees:"الرسوم الحالية",
    medical_records:"السجلات الطبية"
  };
  return map[id]||id;
}

function analyze(){
  const txt=document.getElementById("userText").value.trim();
  if(!txt){alert("اكتبي طلبك"); return;}
  const pkg=detectIntent(txt);
  showPackage(pkg);
}

function executePackage(){
  const title=document.getElementById("intentTitle").innerText;
  const ready=document.getElementById("readyText").innerText;
  const execBtn=document.getElementById("executeBtn");
  execBtn.disabled=true; execBtn.innerText="جارٍ التنفيذ...";
  document.getElementById("execStatus").style.opacity="0.7";

  setTimeout(()=>{
    if(ready.includes("نحتاج")){
      alert("بعض الفحوصات لم تكن جاهزة. النظام جهّز لك خطوات تصحيحية.");
      execBtn.disabled=false; execBtn.innerText="حاول التنفيذ مجدداً";
      document.getElementById("execStatus").style.opacity="1";
      return;
    }
    alert(`تم تنفيذ حزمة "${title}" بنجاح ✅`);
    execBtn.innerText="تم التنفيذ"; execBtn.style.background="#2e8b57";
    document.getElementById("execStatus").style.opacity="1";
  },1200);
}

function clearAll(){
  document.getElementById("userText").value="";
  document.getElementById("resultBox").style.display="none";
  document.getElementById("executeBtn").disabled=false;
  document.getElementById("executeBtn").innerText="تنفيذ كلّ المتطلبات";
  document.getElementById("execStatus").style.opacity="1";
  document.getElementById("readyText").innerText="غير جاهز";
}
</script>
</body>
</html>